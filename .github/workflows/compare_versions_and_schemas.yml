compare_versions_and_schemas:
  stage: pre-merge
  script:
    - |
      echo "Fetching project version and schema-variables.yml from master branch..."
      git fetch origin master
      master_version=$(git show origin/master:pom.xml | mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
      git show origin/master:.github/workflows/build-deploy-image/schemas_versions.yml > master_schema-variables.yml

    - |
      echo "Using project version and schema-variables.yml from the current (merged) branch..."
      feature_version=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
      cp .github/workflows/build-deploy-image/schemas_versions.yml feature_schema-variables.yml

    - |
      echo "Comparing project versions..."
      if [ "$master_version" == "$feature_version" ]; then
          echo "Project version is unchanged"
          VERSION_CHANGED=false
      else
          echo "Project version has changed"
          VERSION_CHANGED=true
      fi

    - |
      echo "Comparing schema files..."
      if diff -q master_schema-variables.yml feature_schema-variables.yml > /dev/null; then
          echo "No changes in schema-variables.yml"
          SCHEMA_CHANGED=false
      else
          echo "Changes detected in schema-variables.yml"
          SCHEMA_CHANGED=true
      fi

    - |
      if [ "$SCHEMA_CHANGED" = true ] && [ "$VERSION_CHANGED" = false ]; then
          echo "ERROR: Schema files are different but project version is unchanged. Please increment the project version before merging."
          exit 1
      fi
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
